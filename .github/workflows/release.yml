name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»ºå’Œä¸Šä¼ release
  packages: write  # å…è®¸ä¸Šä¼ åŒ…
  issues: write    # å…è®¸åˆ›å»ºissuesï¼ˆå¦‚æœéœ€è¦ï¼‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆchangelog
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Type check
      run: npm run type-check
      
    - name: Build extension
      run: npm run build
      
    - name: Package extension
      run: npm run package
      
    - name: Generate Changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬"
          CHANGELOG="## ğŸ‰ é¦–æ¬¡å‘å¸ƒ
        
        ### åŠŸèƒ½ç‰¹æ€§
        - æ”¯æŒAIHCæ§åˆ¶å°é¡µé¢è‡ªåŠ¨è¯†åˆ«
        - ç”ŸæˆCLIå‘½ä»¤ã€JSONå‚æ•°ã€YAMLå‚æ•°
        - æä¾›APIæ–‡æ¡£æŸ¥çœ‹åŠŸèƒ½
        - æ”¯æŒå¤šç§é¡µé¢ç±»å‹å¤„ç†
        - ç°ä»£åŒ–çš„Reactç•Œé¢è®¾è®¡
        - å“åº”å¼å¸ƒå±€ï¼Œæ”¯æŒä¸åŒå±å¹•å°ºå¯¸"
        else
          echo "ç”Ÿæˆä» $PREV_TAG åˆ° ${{ github.ref_name }} çš„å˜æ›´æ—¥å¿—"
          # ç”Ÿæˆç®€å•çš„å˜æ›´æ—¥å¿—
          CHANGELOG="## ğŸ“ æ›´æ–°æ—¥å¿—
        
        ### ä» $PREV_TAG åˆ° ${{ github.ref_name }} çš„å˜æ›´
        
        \`\`\`
        $(git log --oneline $PREV_TAG..HEAD)
        \`\`\`"
        fi
        
        # å°†changelogå†™å…¥æ–‡ä»¶
        echo "$CHANGELOG" > CHANGELOG_TEMP.md
        
        # è®¾ç½®è¾“å‡º
        {
          echo "changelog<<EOF"
          echo "$CHANGELOG"
          echo "EOF"
        } >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: AIHCåŠ©æ‰‹æµè§ˆå™¨æ‰©å±• ${{ github.ref_name }}
        body: |
          ## ğŸš€ AIHCåŠ©æ‰‹æµè§ˆå™¨æ‰©å±• ${{ github.ref_name }}
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `aihc-helper-extension-${{ github.ref_name }}.zip` æ–‡ä»¶
          2. è§£å‹ç¼©æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
          3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
          4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
          6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          7. æ‰©å±•ç¨‹åºå°†è‡ªåŠ¨å®‰è£…å¹¶å¯ç”¨
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¯ **æ™ºèƒ½é¡µé¢è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«AIHCæ§åˆ¶å°çš„å„ç§é¡µé¢
          - ğŸ”§ **CLIå‘½ä»¤ç”Ÿæˆ**: ä¸€é”®ç”Ÿæˆå¯¹åº”çš„å‘½ä»¤è¡Œå·¥å…·å‘½ä»¤
          - ğŸ“„ **å‚æ•°æ ¼å¼åŒ–**: æ”¯æŒJSONå’ŒYAMLæ ¼å¼çš„å‚æ•°ç”Ÿæˆ
          - ğŸ“š **APIæ–‡æ¡£**: é›†æˆç›¸å…³APIæ–‡æ¡£æŸ¥çœ‹åŠŸèƒ½
          - ğŸ¨ **ç°ä»£ç•Œé¢**: åŸºäºReactçš„ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢
          - ğŸ“± **å“åº”å¼è®¾è®¡**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
          
          ### ğŸ› ï¸ æŠ€æœ¯æ ˆ
          - React 18 + TypeScript
          - Vite æ„å»ºå·¥å…·
          - Chrome Extension Manifest V3
          - ç™¾åº¦äº‘SDKé›†æˆ
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Chrome 88+ æˆ–åŸºäºChromiumçš„æµè§ˆå™¨
          - æ”¯æŒAIHCæ§åˆ¶å°è®¿é—®æƒé™
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼åé¦ˆï¼š
          - [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          - é‚®ç®±è”ç³»ç»´æŠ¤è€…
          
          ### ğŸ“„ è®¸å¯è¯
          æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](https://github.com/${{ github.repository }}/blob/main/LICENSE)
        files: |
          aihc-helper-extension-${{ github.ref_name }}.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Extension Files
      uses: actions/upload-artifact@v4
      with:
        name: extension-files-${{ github.ref_name }}
        path: |
          dist/
          aihc-helper-extension-${{ github.ref_name }}.zip
        retention-days: 30
        
    - name: Cleanup
      run: |
        rm -f CHANGELOG_TEMP.md
