name: Deploy Docs to GitHub Pages

on:
  push:
    branches: [ main ]
    paths: [ '.qoder/repowiki/zh/**' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g marked highlight.js

      - name: Build documentation
        run: |
          mkdir -p dist-docs
          mkdir -p dist-docs/content
          
          # å¤åˆ¶æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶
          cp -r .qoder/repowiki/zh/content/* dist-docs/content/
          cp -r .qoder/repowiki/zh/meta dist-docs/
          
          # åˆ›å»ºæ–‡æ¡£å¯¼èˆªç´¢å¼•
          echo "# ç”Ÿæˆæ–‡æ¡£å¯¼èˆªç´¢å¼•"
          cat > build-nav.cjs << 'NAVEOF'
          const fs = require('fs');
          const path = require('path');
          
          // åŠ è½½å…ƒæ•°æ®
          let metadata = null;
          try {
            const metadataPath = 'dist-docs/meta/repowiki-metadata.json';
            if (fs.existsSync(metadataPath)) {
              metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));
              console.log('âœ… æˆåŠŸåŠ è½½å…ƒæ•°æ®ï¼ŒåŒ…å«', metadata.wiki_catalogs?.length || 0, 'ä¸ªç›®å½•é¡¹');
            }
          } catch (e) {
            console.log('âš ï¸ æ— æ³•åŠ è½½å…ƒæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ’åº');
          }
          
          // åˆ›å»ºæ–‡æ¡£ç›®å½•æ˜ å°„
          const catalogMap = new Map();
          if (metadata && metadata.wiki_catalogs) {
            metadata.wiki_catalogs.forEach(catalog => {
              catalogMap.set(catalog.name, {
                order: catalog.order || 999,
                description: catalog.description || '',
                name: catalog.name
              });
            });
          }
          
          function scanDirectory(dir, basePath = '') {
            const items = [];
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            
            entries.forEach(entry => {
              if (entry.isDirectory()) {
                // è·³è¿‡ meta ç›®å½•
                if (entry.name === 'meta') return;
                
                const subItems = scanDirectory(path.join(dir, entry.name), path.join(basePath, entry.name));
                if (subItems.length > 0) {
                  const catalogInfo = catalogMap.get(entry.name);
                  items.push({
                    type: 'folder',
                    name: entry.name,
                    order: catalogInfo?.order || 999,
                    description: catalogInfo?.description || '',
                    children: subItems
                  });
                }
              } else if (entry.name.endsWith('.md')) {
                const filePath = path.join(dir, entry.name);
                let title = entry.name.replace('.md', '');
                
                // å°è¯•ä»æ–‡ä»¶å†…å®¹æå–æ ‡é¢˜
                try {
                  const content = fs.readFileSync(filePath, 'utf8');
                  const titleMatch = content.match(/^#\s+(.+)$/m);
                  if (titleMatch) {
                    title = titleMatch[1].trim();
                  }
                } catch (e) {
                  console.log('æ— æ³•è¯»å–æ–‡ä»¶:', filePath);
                }
                
                const catalogInfo = catalogMap.get(title) || catalogMap.get(entry.name.replace('.md', ''));
                items.push({
                  type: 'file',
                  name: entry.name,
                  title: title,
                  path: path.join(basePath, entry.name).replace(/\\/g, '/'),
                  order: catalogInfo?.order || 999,
                  description: catalogInfo?.description || ''
                });
              }
            });
            
            // æŒ‰orderæ’åºï¼Œorderç›¸åŒæ—¶æŒ‰åç§°æ’åº
            items.sort((a, b) => {
              if (a.order !== b.order) {
                return a.order - b.order;
              }
              return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            return items;
          }
          
          const docs = scanDirectory('dist-docs/content');
          
          // ç”Ÿæˆå¯¼èˆªæ•°æ®
          const navData = {
            docs: docs,
            metadata: {
              totalDocs: metadata?.wiki_catalogs?.length || 0,
              generatedAt: new Date().toISOString(),
              hasMetadata: !!metadata
            }
          };
          
          fs.writeFileSync('dist-docs/docs-nav.json', JSON.stringify(navData, null, 2));
          console.log('ğŸ“š æ–‡æ¡£å¯¼èˆªç”Ÿæˆå®Œæˆï¼Œå…±å¤„ç†', docs.length, 'ä¸ªé¡¹ç›®');
          
          // è°ƒè¯•å¯¼èˆªæ•°æ®ç»“æ„
          console.log('ğŸ“Š å¯¼èˆªæ•°æ®ç»“æ„éªŒè¯:');
          console.log('  - docs ç±»å‹:', Array.isArray(navData.docs) ? 'Array' : typeof navData.docs);
          console.log('  - docs é•¿åº¦:', navData.docs ? navData.docs.length : 0);
          console.log('  - metadata å­˜åœ¨:', !!navData.metadata);
          console.log('  - hasMetadata:', navData.metadata?.hasMetadata);
          
          // æ‰“å°éƒ¨åˆ†å¯¼èˆªæ•°æ®ç”¨äºè°ƒè¯•
          const debugData = {
            docs: navData.docs.slice(0, 2), // åªæ˜¾ç¤ºå‰2é¡¹
            metadata: navData.metadata
          };
          console.log('ğŸ“‹ å¯¼èˆªæ•°æ®æ ·ä¾‹:', JSON.stringify(debugData, null, 2));
          
          // æ‰“å°å¯¼èˆªç»“æ„é¢„è§ˆ
          function printStructure(items, indent = '') {
            items.slice(0, 10).forEach(item => { // åªæ˜¾ç¤ºå‰10é¡¹
              if (item.type === 'folder') {
                console.log(`${indent}ğŸ“ ${item.name} (${item.order})`);
                if (item.children.length > 0) {
                  printStructure(item.children.slice(0, 3), indent + '  ');
                  if (item.children.length > 3) {
                    console.log(`${indent}  ... è¿˜æœ‰ ${item.children.length - 3} é¡¹`);
                  }
                }
              } else {
                console.log(`${indent}ğŸ“„ ${item.title} (${item.order})`);
              }
            });
            if (items.length > 10) {
              console.log(`${indent}... è¿˜æœ‰ ${items.length - 10} é¡¹`);
            }
          }
          
          console.log('\nğŸ“‹ å¯¼èˆªç»“æ„é¢„è§ˆ:');
          printStructure(docs);
          NAVEOF
          
          node build-nav.cjs
          
          # ç”Ÿæˆä¸»é¡µHTML
          cat > dist-docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AIHCåŠ©æ‰‹æ‰©å±• - æ–‡æ¡£ä¸­å¿ƒ</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
              <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
              <style>
                  * { box-sizing: border-box; }
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
                      margin: 0; padding: 0; line-height: 1.6; color: #24292f; background: #f6f8fa;
                  }
                  .container { display: flex; height: 100vh; }
                  .sidebar { 
                      width: 300px; background: #fff; border-right: 1px solid #d1d9e0; 
                      overflow-y: auto; flex-shrink: 0;
                  }
                  .sidebar-header {
                      padding: 20px; border-bottom: 1px solid #d1d9e0; background: #0969da; color: white;
                  }
                  .sidebar-header h1 { margin: 0; font-size: 1.2em; }
                  .sidebar-content { padding: 10px 0; }
                  .nav-item { 
                      display: block; padding: 8px 20px; color: #24292f; text-decoration: none;
                      border-left: 3px solid transparent; transition: all 0.2s;
                  }
                  .nav-item:hover { background: #f6f8fa; border-left-color: #0969da; }
                  .nav-item.active { background: #e7f3ff; border-left-color: #0969da; font-weight: 600; }
                  .nav-folder { 
                      padding: 8px 20px; font-weight: 600; color: #656d76; 
                      cursor: pointer; user-select: none;
                  }
                  .nav-folder:hover { background: #f6f8fa; }
                  .nav-folder.collapsed + .nav-children { display: none; }
                  .nav-children { margin-left: 20px; }
                  .order-badge {
                      background: #0969da; color: white; font-size: 10px; padding: 2px 6px;
                      border-radius: 10px; margin-left: 8px; font-weight: normal;
                  }
                  .main-content { 
                      flex: 1; display: flex; flex-direction: column; overflow: hidden;
                  }
                  .content-header {
                      background: #fff; padding: 15px 30px; border-bottom: 1px solid #d1d9e0;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  }
                  .content-area { 
                      flex: 1; padding: 30px; overflow-y: auto; background: #fff;
                      margin: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  }
                  .content-area h1 { margin-top: 0; color: #24292f; }
                  .content-area h2 { margin-top: 30px; padding-bottom: 10px; border-bottom: 1px solid #d1d9e0; }
                  .content-area pre { 
                      background: #f6f8fa; padding: 16px; border-radius: 6px; 
                      overflow-x: auto; border: 1px solid #d1d9e0;
                  }
                  .content-area code { 
                      background: #f6f8fa; padding: 2px 6px; border-radius: 3px; 
                      font-family: 'SFMono-Regular', Consolas, monospace;
                  }
                  .content-area pre code { background: none; padding: 0; }
                  .content-area blockquote {
                      border-left: 4px solid #0969da; padding-left: 16px; 
                      margin-left: 0; color: #656d76;
                  }
                  .content-area table {
                      border-collapse: collapse; width: 100%; margin: 20px 0;
                  }
                  .content-area th, .content-area td {
                      border: 1px solid #d1d9e0; padding: 8px 12px; text-align: left;
                  }
                  .content-area th { background: #f6f8fa; font-weight: 600; }
                  .welcome-content {
                      text-align: center; padding: 60px 40px;
                  }
                  .welcome-content h1 { font-size: 2.5em; margin-bottom: 20px; color: #0969da; }
                  .welcome-content p { font-size: 1.2em; color: #656d76; margin-bottom: 30px; }
                  .feature-grid {
                      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px; margin-top: 40px;
                  }
                  .feature-card {
                      background: #f6f8fa; padding: 20px; border-radius: 8px;
                      border: 1px solid #d1d9e0; text-align: left;
                  }
                  .feature-card h3 { margin-top: 0; color: #0969da; }
                  @media (max-width: 768px) {
                      .container { flex-direction: column; }
                      .sidebar { width: 100%; height: auto; }
                      .main-content { height: calc(100vh - 200px); }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="sidebar">
                      <div class="sidebar-header">
                          <h1>ğŸ“š AIHCåŠ©æ‰‹æ–‡æ¡£</h1>
                      </div>
                      <div class="sidebar-content" id="nav-container">
                          <!-- å¯¼èˆªå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                      </div>
                  </div>
                  
                  <div class="main-content">
                      <div class="content-header">
                          <h2 id="page-title">AIHCåŠ©æ‰‹æµè§ˆå™¨æ‰©å±•</h2>
                      </div>
                      
                      <div class="content-area" id="content">
                          <div class="welcome-content">
                              <h1>ğŸš€ æ¬¢è¿ä½¿ç”¨ AIHCåŠ©æ‰‹</h1>
                              <p>ä¸ºç™¾èˆ¸AIHCæ§åˆ¶å°æä¾›ä¾¿æ·çš„CLIå‘½ä»¤ç”Ÿæˆã€APIæ–‡æ¡£å’Œæ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½</p>
                              
                              <div class="feature-grid">
                                  <div class="feature-card">
                                      <h3>ğŸ¯ æ™ºèƒ½è¯†åˆ«</h3>
                                      <p>è‡ªåŠ¨è¯†åˆ«å½“å‰é¡µé¢å¹¶æä¾›ç›¸åº”çš„åŠŸèƒ½æ”¯æŒ</p>
                                  </div>
                                  <div class="feature-card">
                                      <h3>âš¡ å¿«é€Ÿæ“ä½œ</h3>
                                      <p>ä¸€é”®ç”ŸæˆCLIå‘½ä»¤ï¼Œæé«˜å·¥ä½œæ•ˆç‡</p>
                                  </div>
                                  <div class="feature-card">
                                      <h3>ğŸ“– å®Œæ•´æ–‡æ¡£</h3>
                                      <p>è¯¦ç»†çš„APIå‚è€ƒå’Œä½¿ç”¨æŒ‡å—</p>
                                  </div>
                                  <div class="feature-card">
                                      <h3>ğŸ”§ æ˜“äºæ‰©å±•</h3>
                                      <p>æ¨¡å—åŒ–æ¶æ„ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <script>
                  let docsNav = {};
                  let currentFile = null;
                  
                  // åŠ è½½å¯¼èˆªæ•°æ®
                  fetch('docs-nav.json')
                      .then(response => {
                          console.log('ğŸ”„ åŠ è½½ docs-nav.json, çŠ¶æ€:', response.status);
                          if (!response.ok) {
                              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                          }
                          return response.json();
                      })
                      .then(data => {
                          console.log('ğŸ“Š åŠ è½½çš„åŸå§‹æ•°æ®ç±»å‹:', typeof data);
                          console.log('ğŸ“Š æ•°æ®é”®å€¼:', Object.keys(data || {}));
                          
                          // éªŒè¯æ•°æ®ç»“æ„
                          if (!data) {
                              throw new Error('å¯¼èˆªæ•°æ®ä¸ºç©º');
                          }
                          
                          if (!data.docs) {
                              console.error('âŒ æ•°æ®ç»“æ„é”™è¯¯: ç¼ºå°‘ docs å­—æ®µ');
                              console.log('å®é™…æ•°æ®:', data);
                              throw new Error('æ•°æ®ç»“æ„é”™è¯¯: ç¼ºå°‘ docs å­—æ®µ');
                          }
                          
                          if (!Array.isArray(data.docs)) {
                              console.error('âŒ docs ä¸æ˜¯æ•°ç»„:', typeof data.docs);
                              throw new Error('docs å­—æ®µä¸æ˜¯æ•°ç»„');
                          }
                          
                          docsNav = data;
                          console.log('âœ… æ•°æ®éªŒè¯æˆåŠŸ - docsæ•°é‡:', data.docs.length);
                          console.log('ğŸ“ å…ƒæ•°æ®ä¿¡æ¯:', data.metadata);
                          
                          renderNavigation();
                          
                          // æ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
                          if (data.metadata?.hasMetadata) {
                              console.log('âœ… ä½¿ç”¨å…ƒæ•°æ®æ’åºï¼Œå…±', data.metadata.totalDocs, 'ä¸ªæ–‡æ¡£');
                          } else {
                              console.log('âš ï¸ ä½¿ç”¨é»˜è®¤æ’åº');
                          }
                      })
                      .catch(error => {
                          console.error('âŒ åŠ è½½å¯¼èˆªå¤±è´¥:', error);
                          console.error('Error details:', error.message);
                          
                          // è®¾ç½®é»˜è®¤æ•°æ®ç»“æ„
                          docsNav = {
                              docs: [],
                              metadata: {
                                  hasMetadata: false,
                                  totalDocs: 0,
                                  error: error.message
                              }
                          };
                          
                          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                          const container = document.getElementById('nav-container');
                          if (container) {
                              container.innerHTML = `
                                  <div style="padding: 20px; color: #d73a49; background: #ffeef0; margin: 10px; border-radius: 6px;">
                                      <h4>âš ï¸ å¯¼èˆªåŠ è½½å¤±è´¥</h4>
                                      <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                                      <details style="margin-top: 10px;">
                                          <summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</summary>
                                          <pre style="background: #f6f8fa; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px;">${error.stack || 'æ— è¯¦ç»†ä¿¡æ¯'}</pre>
                                      </details>
                                      <p style="margin-top: 10px;"><small>è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯</small></p>
                                  </div>
                              `;
                          }
                      });
                  
                  function renderNavigation() {
                      const container = document.getElementById('nav-container');
                      container.innerHTML = renderNavItems(docsNav.docs || []);
                      
                      // ç»‘å®šæ–‡ä»¶å¤¹åˆ‡æ¢äº‹ä»¶
                      container.querySelectorAll('.nav-folder').forEach(folder => {
                          folder.addEventListener('click', function() {
                              this.classList.toggle('collapsed');
                          });
                      });
                  }
                  
                  function renderNavItems(items, level = 0) {
                      return items.map(item => {
                          if (item.type === 'folder') {
                              const orderBadge = item.order !== 999 ? ` <span class="order-badge">${item.order}</span>` : '';
                              return `
                                  <div class="nav-folder" title="é¡ºåº: ${item.order}">
                                      ğŸ“ ${item.name}${orderBadge}
                                  </div>
                                  <div class="nav-children">
                                      ${renderNavItems(item.children, level + 1)}
                                  </div>
                              `;
                          } else {
                              const orderBadge = item.order !== 999 ? ` <span class="order-badge">${item.order}</span>` : '';
                              return `
                                  <a href="#" class="nav-item" onclick="loadDoc('${item.path}', '${item.title}')" title="é¡ºåº: ${item.order}">
                                      ğŸ“„ ${item.title}${orderBadge}
                                  </a>
                              `;
                          }
                      }).join('');
                  }
                  
                  function loadDoc(filePath, title) {
                      currentFile = filePath;
                      document.getElementById('page-title').textContent = title;
                      
                      // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                      document.querySelectorAll('.nav-item').forEach(item => {
                          item.classList.remove('active');
                      });
                      event.target.classList.add('active');
                      
                      // åŠ è½½Markdownæ–‡ä»¶
                      fetch(`content/${filePath}`)
                          .then(response => response.text())
                          .then(markdown => {
                              const html = marked.parse(markdown);
                              document.getElementById('content').innerHTML = html;
                              
                              // é«˜äº®ä»£ç 
                              document.querySelectorAll('pre code').forEach(block => {
                                  hljs.highlightBlock(block);
                              });
                          })
                          .catch(error => {
                              console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
                              document.getElementById('content').innerHTML = 
                                  '<div style="text-align:center;padding:50px;"><h2>âŒ æ–‡æ¡£åŠ è½½å¤±è´¥</h2><p>è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–ç½‘ç»œè¿æ¥</p></div>';
                          });
                  }
                  
                  // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªæ–‡æ¡£
                  setTimeout(() => {
                      const firstDoc = findFirstDoc(docsNav.docs || []);
                      if (firstDoc) {
                          loadDoc(firstDoc.path, firstDoc.title);
                      }
                  }, 100);
                  
                  function findFirstDoc(items) {
                      for (const item of items) {
                          if (item.type === 'file') {
                              return item;
                          } else if (item.children) {
                              const found = findFirstDoc(item.children);
                              if (found) return found;
                          }
                      }
                      return null;
                  }
              </script>
          </body>
          </html>
          HTMLEOF
          
          # åˆ›å»º.nojekyllæ–‡ä»¶
          touch dist-docs/.nojekyll
          
          echo "ğŸ“ Documentation structure:"
          find dist-docs -type f -name "*.md" | head -10
          echo "ğŸ’¾ æ£€æŸ¥ç”Ÿæˆçš„å¯¼èˆªæ–‡ä»¶:"
          if [ -f "dist-docs/docs-nav.json" ]; then
            echo "âœ… docs-nav.json æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“‹ æ–‡ä»¶å¤§å°: $(wc -c < dist-docs/docs-nav.json) å­—ç¬¦"
            echo "ğŸ“„ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            head -20 dist-docs/docs-nav.json
            echo "..."
          else
            echo "âŒ docs-nav.json æ–‡ä»¶ä¸å­˜åœ¨!"
            echo "ğŸ“‚ dist-docs ç›®å½•å†…å®¹:"
            ls -la dist-docs/
          fi
          echo "âœ… Documentation build complete!"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist-docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4