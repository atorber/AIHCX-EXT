# 调试与故障排除

<cite>
**本文档引用的文件**  
- [simple-debug.js](file://scripts/simple-debug.js)
- [index.ts](file://src/content/index.ts)
- [index.ts](file://src/background/index.ts)
- [aihcApi.ts](file://src/services/aihcApi.ts)
- [PopupContainer.tsx](file://src/components/PopupContainer.tsx)
- [chromeApi.ts](file://src/utils/chromeApi.ts)
- [errorFilter.ts](file://src/utils/errorFilter.ts)
- [manifest.json](file://src/manifest.json)
</cite>

## 目录
1. [常见问题排查](#常见问题排查)  
2. [使用Chrome开发者工具调试](#使用chrome开发者工具调试)  
3. [simple-debug.js 脚本使用指南](#simple-debugjs-脚本使用指南)  
4. [网络请求与API凭证问题诊断](#网络请求与api凭证问题诊断)  
5. [推荐诊断策略](#推荐诊断策略)

## 常见问题排查

### 扩展无法加载
当插件未正常加载时，可能的原因包括：
- 浏览器未启用开发者模式
- 插件未正确安装或路径错误
- `manifest.json` 配置有误导致加载失败

检查 `build-verify.sh` 脚本输出可确认构建产物完整性。若 `dist/content/index.js` 文件缺失，则需重新构建项目。

**解决方案：**
1. 确保在 Chrome 的 `chrome://extensions/` 页面中开启“开发者模式”
2. 点击“加载已解压的扩展程序”，选择 `dist` 文件夹
3. 检查控制台是否有语法或模块加载错误

### 权限错误
权限不足通常表现为 API 请求返回 403 错误。这可能是由于：
- 用户账号缺少对应资源池访问权限
- 凭证（ak/sk）未配置或失效
- 扩展缺少必要的权限声明

根据 `manifest.json` 中定义的权限 `"permissions": ["storage", "activeTab", "tabs", "sidePanel", "notifications"]`，确保这些权限已被授予。

**解决方案：**
- 在插件设置页面重新输入有效的 AK/SK
- 联系管理员确认账号权限
- 清除本地存储后重试

### 页面识别失败
插件依赖 URL 匹配规则来判断是否注入内容脚本。当前仅对 `*://console.bce.baidu.com/*` 生效。

若页面未被识别，检查以下逻辑：
- 当前页面 URL 是否符合匹配模式
- `pageDetection.ts` 是否正确解析了路径和参数
- 是否因缓存或防抖机制延迟触发

部分页面如数据转储页会跳过 TAB 导航渲染，直接显示表单组件。

**解决方案：**
- 刷新页面以触发重新检测
- 检查 `getCurrentTabInfo()` 返回结果是否准确
- 查看 `PopupContainer.tsx` 中的路由处理逻辑

**Section sources**  
- [manifest.json](file://src/manifest.json#L28-L30)
- [PopupContainer.tsx](file://src/components/PopupContainer.tsx#L499-L546)

## 使用Chrome开发者工具调试

### 查看 background page 日志
Background Script 是插件的核心运行环境，负责消息通信、状态管理和 API 调用。

**操作步骤：**
1. 打开 `chrome://extensions/`
2. 找到 “AIHC助手” 插件并点击“背景页”链接
3. 在弹出的 DevTools 控制台中查看日志输出

重点关注以下行为：
- `chrome.runtime.onInstalled` 初始化日志
- `onMessage.addListener` 消息收发记录
- `getCredentials()` 凭证读取过程
- 各类 API 调用异常堆栈

例如，在 `background/index.ts` 中通过 `console.log('[AIHC助手] 扩展图标被点击')` 输出用户交互事件。

### 查看 content script 日志
Content Script 注入目标网页 DOM，实现 UI 交互与数据提取。

**操作步骤：**
1. 访问受支持页面（如 `https://console.bce.baidu.com/aihc`）
2. 打开页面级 DevTools（F12）
3. 查看 Console 标签下的日志

关键日志包括：
- `[AIHC助手] 内容脚本已加载`
- `[AIHC助手] 检测到AIHC控制台页面`
- 表单填充过程中的字段匹配信息

注意：生产环境下仅输出错误日志，开发环境可通过 `process.env.NODE_ENV === 'development'` 控制详细日志。

**Section sources**  
- [index.ts](file://src/background/index.ts#L1-L513)
- [index.ts](file://src/content/index.ts#L0-L938)

## simple-debug.js 脚本使用指南

该脚本位于 `scripts/simple-debug.js`，用于快速测试表单自动填充功能。

### 功能概述
- 提供 `testDataset()` 和 `testModel()` 快捷函数
- 支持手动验证字段存在性（`checkPage()`）
- 模拟 React 输入框值变更流程

### 使用方法
1. 复制 `simple-debug.js` 全部内容
2. 在目标页面打开 DevTools
3. 粘贴至 Console 并执行
4. 运行 `quickTestDataset()` 或 `quickTestModel()`

脚本将自动：
- 定位单选按钮并触发切换
- 使用 `Object.getOwnPropertyDescriptor` 修改 input 值
- 派发 `input` 和 `change` 事件以激活 React 绑定
- 输出填充结果及最终字段值

```javascript
// 示例输出
🚀 测试填充 数据集
✅ 单选按钮已切换到 DATASET
✅ 名称字段已填充: openai/gdpval
✅ 子路径字段已填充: huggingface.co/datasets/openai/gdpval
🎉 填充完成！成功 3 个字段
```

此脚本特别适用于调试动态表单绑定问题。

**Section sources**  
- [simple-debug.js](file://scripts/simple-debug.js#L0-L184)

## 网络请求与API凭证问题诊断

### 网络请求失败
常见 HTTP 错误码及其含义：

| 状态码 | 含义 | 可能原因 |
|--------|------|----------|
| 404 | 资源不存在 | URL 错误或服务未部署 |
| 500 | 服务器内部错误 | 后端异常或配置错误 |
| 403 | 权限不足 | 凭证无效或角色限制 |
| 401 | 认证失败 | AK/SK 缺失或过期 |

在 `aihcApi.ts` 中捕获错误时，会根据响应码提示具体信息，如：
```ts
if (response.status === 403) {
  errorMsg = '访问被拒绝，权限不足';
}
```

此外，`fetch` 请求可能抛出 `AbortError`，表示请求被取消（常用于防抖场景）。

### API凭证无效
凭证提取逻辑集中在 `common.ts` 和 `chromeApi.ts` 中。

#### 提取优先级：
1. `Authorization: Bearer ak|sk|region`
2. `token: ak|sk|region`
3. `x-api-key: ak|sk|region`
4. 存储中的同步项 (`chrome.storage.sync.get(['ak', 'sk'])`)

若所有来源均无有效凭证，则抛出错误：“缺少必要凭证(ak, sk)”。

**排查步骤：**
1. 检查设置页面是否保存了 AK/SK
2. 查看 `chrome.storage.sync` 实际存储值
3. 验证头部格式是否为 `ak|sk` 分隔形式
4. 尝试清除存储并重新登录

**Section sources**  
- [aihcApi.ts](file://src/services/aihcApi.ts#L386-L414)
- [common.ts](file://src/utils/common.ts#L28-L109)
- [chromeApi.ts](file://src/utils/chromeApi.ts#L33-L86)

## 推荐诊断策略

### 启用错误过滤器
`errorFilter.ts` 自动屏蔽第三方警告，提升可读性。

```ts
const WARNING_FILTERS = [
  'TrackRoute',
  'nested',
  'Portal Assistant loaded'
];

const ERROR_FILTERS = [
  'Could not establish connection',
  'Extension context invalidated'
];
```

仅在开发模式下显示 `[已过滤警告]`，避免干扰核心日志。

### 结构化日志输出
建议按模块添加前缀，如：
- `[AIHC助手]`
- `[表单填充]`
- `[API调用]`

结合颜色样式增强辨识度：
```js
console.log('%c[AIHC助手] 成功打开侧边栏', 'color: #2196F3');
```

### 异常链追踪
对于嵌套异步调用（如 fetch → json → 处理），应逐层捕获并附加上下文信息，便于定位源头。

### 日志级别控制
利用环境变量区分输出等级：
```ts
if (isDevelopment && isImportant) {
  console.log(...);
} else if (level === 'error') {
  console.error(...);
}
```

确保生产环境不泄露敏感信息。

**Section sources**  
- [errorFilter.ts](file://src/utils/errorFilter.ts#L0-L87)
- [index.ts](file://src/content/index.ts#L10-L25)