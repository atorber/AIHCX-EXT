# 工具函数

<cite>
**本文档中引用的文件**
- [chromeApi.ts](file://src/utils/chromeApi.ts)
- [common.ts](file://src/utils/common.ts)
- [errorFilter.ts](file://src/utils/errorFilter.ts)
- [pageDetection.ts](file://src/utils/pageDetection.ts)
- [resourcePools.ts](file://src/utils/resourcePools.ts)
</cite>

## 目录
1. [简介](#简介)
2. [Chrome API 封装](#chrome-api-封装)
3. [通用工具方法](#通用工具方法)
4. [异常过滤机制](#异常过滤机制)
5. [页面类型识别](#页面类型识别)
6. [资源池数据处理辅助](#资源池数据处理辅助)

## 简介
本文档系统化地描述了 AIHCX 扩展中的核心工具函数模块。这些工具函数分布在 `src/utils` 目录下，分别负责 Chrome API 的安全调用、通用数据处理、控制台错误过滤、当前页面识别以及资源池相关数据的远程获取等功能。通过这些模块化的工具函数，扩展实现了更高的稳定性、可维护性和用户体验。

## Chrome API 封装

`chromeApi.ts` 模块对原始 Chrome 扩展 API 进行了封装，主要目的是提升调用的安全性与易用性。该模块将异步的 Chrome API 调用转换为基于 Promise 的接口，并对可能发生的错误进行静默处理，避免因 API 调用失败而导致的控制台报错和程序中断。

模块提供了对 `storage`、`runtime` 和 `tabs` 三个核心 API 的访问：
- **storage.sync/local**: 提供同步和本地存储的 `get` 和 `set` 方法，用于持久化用户凭证、任务列表和配置信息。
- **runtime.sendMessage**: 封装消息发送逻辑，捕获并静默处理 `lastError`，确保通信失败不会影响主流程。
- **runtime.openOptionsPage**: 安全地打开扩展选项页，即使调用失败也不会抛出异常。
- **tabs.create/query**: 提供创建新标签页和查询当前标签页的功能。

此外，该模块还封装了多个高层级的便捷函数，如 `getCredentials`、`saveCredentials`、`getTasks`、`shouldShowUserGuide` 等，这些函数直接操作存储空间，简化了业务逻辑层的数据存取代码。

**Section sources**
- [chromeApi.ts](file://src/utils/chromeApi.ts#L3-L132)

## 通用工具方法

`common.ts` 文件包含了项目中广泛使用的通用工具函数，涵盖了字符串处理、对象格式化、凭证提取和命令生成等多个方面。

### 凭证提取
`extractCredentials` 函数从 HTTP 请求头中提取百度云所需的 AK/SK 凭证和区域信息。它支持从 `ak/sk`、`Authorization`、`token` 和 `x-api-key` 多个头部字段获取凭证，并能处理以 `|` 分隔的复合值（包含 region）。函数会对所有头部名进行小写归一化处理，并在缺少必要凭证时抛出明确的错误。

### 字符串与对象处理
- `toCamelCase`: 将连字符分隔的字符串（如 `hello-world`）转换为小驼峰命名（`helloWorld`）。
- `formatRequestParams`: 将用户输入的参数对象格式化为符合后端 API 要求的请求体。该函数会处理作业框架、资源规格、环境变量、数据源挂载等复杂结构，并设置合理的默认值。

### 输出格式化
- `generateYAML`: 利用 `js-yaml` 库将 JavaScript 对象转换为格式良好的 YAML 字符串，用于生成配置文件。
- `generateCLICommand`: 根据任务信息生成可在终端执行的 `aihc` CLI 命令。函数会动态添加队列、GPU资源、RDMA、BCCL、容错、环境变量、数据源等参数，极大地方便了用户的命令行操作。

**Section sources**
- [common.ts](file://src/utils/common.ts#L4-L355)

## 异常过滤机制

`errorFilter.ts` 模块旨在净化浏览器开发者工具中的控制台输出，过滤掉由第三方脚本或 Chrome 扩展自身引发的无关紧要的警告和错误，从而减少噪音，便于开发者专注于真正的问题。

该模块通过重写 `console.warn` 和 `console.error` 方法来实现过滤：
1. 定义了 `WARNING_FILTERS` 和 `ERROR_FILTERS` 两个数组，其中包含了一系列需要被过滤的关键词。
2. 在重写的 `console.warn` 和 `console.error` 函数中，首先将所有参数拼接成字符串。
3. 检查该字符串是否包含任何预设的过滤关键词。
4. 如果匹配，则根据当前环境决定是否完全丢弃日志（生产环境）或标记为 `[已过滤警告/错误]` 后输出（开发环境）。
5. 若不匹配，则调用原始的 `console` 方法正常输出。

此机制在模块加载时自动初始化（`initErrorFilter()`），无需手动调用，有效提升了开发和调试体验。

**Section sources**
- [errorFilter.ts](file://src/utils/errorFilter.ts#L36-L84)

## 页面类型识别

`pageDetection.ts` 模块负责识别当前浏览器标签页所处的 AIHC 控制台的具体功能页面。这对于扩展判断是否激活、显示何种 UI 组件至关重要。

其核心功能包括：
- **URL 模式匹配**: 维护一个 `urlPatterns` 映射表，将特定的 URL 前缀映射到具体的页面名称（如“任务列表”、“模型详情”等）。
- `detectPageType`: 主检测函数。首先验证 URL 是否属于 AIHC 控制台域名，然后按模式长度降序遍历 `urlPatterns`，确保更精确的规则优先匹配。匹配成功则返回对应的页面信息，否则返回不支持的提示。
- `parseUrl`: 解析 URL，分离出基础路径和查询参数，便于后续处理。
- `getCurrentTabInfo`: 获取当前活动标签页的信息。在后台脚本中使用 `chrome.tabs.query`，在内容脚本中直接读取 `window.location.href`，然后调用 `detectPageType` 进行分析。

该模块使得扩展能够智能地响应不同页面，提供精准的上下文功能。

**Section sources**
- [pageDetection.ts](file://src/utils/pageDetection.ts#L29-L150)

## 资源池数据处理辅助

`resourcePools.ts` 模块提供了与 AIHC 后端 API 交互的工具函数，专门用于获取资源池列表。

- `DescribeResourcePools`: 该异步函数接收 AK、SK 和 region 作为参数，构造符合百度云签名规范的 HTTP 请求。它使用 `common.ts` 中的 `getSignature` 函数生成 Authorization 头，并通过 `fetch` 发起 GET 请求到 `/api/v1/resourcepools` 接口。
- 函数内部设置了固定的分页参数（pageSize=100, pageNo=1）和排序规则（按创建时间倒序）。
- 实现了完整的错误处理机制，包括网络错误、HTTP 状态码非 2xx 以及 API 返回数据格式错误等情况，确保函数调用的健壮性。无论发生何种错误，函数最终都会返回一个空数组，避免调用方崩溃。

此工具函数为扩展提供了获取全局资源池视图的能力，是实现高级管理功能的基础。

**Section sources**
- [resourcePools.ts](file://src/utils/resourcePools.ts#L4-L59)